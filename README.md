# Telegram Бот для оповещения о погоде, праздниках и отключениях

Telegram бот, который ежедневно в 7 утро отправляет в указанные группы информацию о:
- Погоде в Красноярске
- Праздниках на текущий день
- Отключениях воды, электричества и других коммунальных услуг

## Особенности

- Оповещения в несколько групп одновременно
- Административная панель на Flask для управления
- Возможность добавления адресов для отслеживания отключений
- Поддержка нескольких администраторов
- Возможность ручной отправки сообщений от имени бота
- Отслеживание и отметка запросов пользователей как выполненных
- Настраиваемый планировщик задач с возможностью выбора времени и групп для отправки
- Модульная архитектура для легкой поддержки и расширения
- Все конфигурации вынесены в отдельные файлы

## Требования

- Python 3.8+
- SQLite (для хранения данных)

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd tg_bot_v2
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Создайте файл `.env` с переменными окружения:
```
TELEGRAM_TOKEN=ваш_токен_телеграм_бота
ADMIN_ID=ID_администратора
OPENWEATHER_API_KEY=ваш_ключ_openweathermap

# Для генерации хэша пароля используйте:
# python generate_password_hash.py <ваш_пароль>
ADMIN_PASSWORD_HASH=хэш_sha512_вашего_пароля
```

4. Запустите бота:
```bash
python main.py --mode bot
```

5. Запустите админку:
```bash
python main.py --mode admin
```

Или используйте скрипты запуска:
```bash
# Windows
run_bot.bat

# Linux/Mac
./run_bot.sh
```

## Использование

### Бот в Telegram

- `/start` - Начать работу с ботом
- `/help` - Показать помощь
- `/weather` - Получить информацию о погоде
- `/holidays` - Получить информацию о праздниках
- `/disconnections` - Получить информацию об отключениях
- `/add_group` - Добавить группу для оповещений
- `/request` - Оставить запрос или сообщить о проблеме

### Админка

Админка доступна по адресу `http://localhost:5000`

Для доступа к админке необходимо ввести пароль, который был задан в переменной окружения `ADMIN_PASSWORD_HASH`.

### Функции админки

- Управление группами (добавление, удаление, включение/отключение)
- Управление администраторами (добавление, удаление)
- Отслеживание запросов пользователей с возможностью отметить как выполненные
- Отправка сообщений от имени бота в любые группы
- Настройка планировщика задач:
  - Включение/отключение различных типов уведомлений
  - Установка времени отправки для каждого типа уведомлений
  - Выбор конкретных групп для отправки уведомлений
  - Поддержка различных типов уведомлений:
    - Ежедневное оповещение (погода, праздники, отключения)
    - Отчет о погоде
    - Отчет о праздниках
    - Отчет об отключениях
  - Тонкая настройка расписания:
    - Ежеминутные задачи (с настраиваемым интервалом)
    - Ежечасные задачи (с настраиваемым интервалом)
    - Ежедневные задачи
    - Еженедельные задачи (с выбором дней недели)
    - Ежемесячные задачи (с выбором дня месяца)
    - Возможность выбора конкретных групп для каждого типа уведомлений
  - **ВАЖНО**: Не рекомендуется настраивать задачи типа "daily_message" с интервалом "minutely" или "hourly", так как это приведет к избыточной отправке сообщений

## Структура проекта

```
tg_bot_v2/
├── databases/              # Модели данных и конфигурация
│   ├── __init__.py
│   ├── config.py           # Конфигурационные параметры
│   └── models.py           # Модели данных SQLAlchemy
├── handlers/               # Обработчики бота
│   ├── __init__.py
│   ├── main.py             # Основной файл инициализации бота
│   ├── commands.py         # Обработчики команд
│   ├── requests.py         # Обработка запросов пользователей
│   └── message_sender.py   # Отправка запланированных сообщений
├── utils/                  # Вспомогательные модули
│   ├── __init__.py
│   ├── parse.py            # Парсинг HTML с отключениями
│   └── send_message.py     # Модуль для отправки сообщений через Telegram API
├── static/                 # Статические файлы админки
│   └── favicon.ico
├── templates/              # Шаблоны админки
│   ├── admins.html
│   ├── base.html
│   ├── groups.html
│   ├── index.html
│   ├── login.html
│   ├── requests.html
│   └── scheduler.html
├── .env                    # Файл с переменными окружения
├── .env.example            # Пример файла с переменными окружения
├── .gitignore              # Файл игнорирования Git
├── admin.py                # Административная панель на Flask
├── disconnections.py       # Получение данных об отключениях
├── generate_password_hash.py  # Генерация хэша пароля для админки
├── holidays.py             # Получение данных о праздниках
├── main.py                 # Точка входа в приложение
├── README.md               # Документация
├── requirements.txt        # Зависимости проекта
├── run_bot.bat             # Скрипт запуска для Windows
├── run_bot.sh              # Скрипт запуска для Linux/Mac
└── weather.py              # Получение данных о погоде
```

## API

- Погода: https://openweathermap.org/api
- Праздники: https://www.calend.ru/rss/russtate.rss
- Отключения: http://93.92.65.26/aspx/centr.htm

## Разработка

Проект следует модульному подходу:
- Все обработчики команд находятся в `handlers/commands.py`
- Логика обработки запросов пользователей в `handlers/requests.py`
- Отправка сообщений реализована в `handlers/message_sender.py`
- Вспомогательные функции вынесены в `utils/`
- Конфигурация и модели данных находятся в `databases/`

Для добавления новых функций рекомендуется следовать этой структуре.

## Тестирование

Проект включает полноценный набор unit-тестов:
- ✅ 25 тестов успешно проходят
- ✅ Покрытие всех основных модулей
- ✅ Использование mocking для внешних зависимостей
- ✅ Асинхронные тесты для функций бота

Тесты находятся в директории `tests/` и могут быть запущены командой:
```bash
pytest tests/ -v
```