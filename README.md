# Power Outages Bot

Telegram бот для уведомлений об отключениях электроэнергии, воды и других коммунальных услуг.

## Структура проекта

- `bot.py` - Основной Telegram бот
- `admin.py` - Веб-интерфейс админки (точка входа)
- `app.py` - Фабрика приложения Flask
- `admin_routes.py` - Маршруты админки в виде Blueprint
- `decorators.py` - Декораторы для Flask приложения
- `error_handlers.py` - Обработчики ошибок для Flask приложения
- `security.py` - Модуль безопасности приложения
- `data/` - Конфигурационные файлы и данные
- `databases/` - Модели данных и конфигурация базы данных
- `handlers/` - Обработчики бота
- `utils/` - Вспомогательные модули
- `templates/` - Шаблоны админки
- `tests/` - Unit-тесты

## Основные компоненты

### Telegram бот (`bot.py`)
Основной компонент, который обрабатывает команды пользователей и отправляет уведомления.

### Планировщик задач (`utils/scheduler.py`)
Фоновый процесс, который периодически проверяет отключения.

### Админка (`admin.py`)
Веб-интерфейс для управления ботом, группами, задачами и просмотра уведомлений.

### База данных (`databases/`)
SQLite база данных с ORM SQLAlchemy для хранения информации об отключениях, группах, задачах и уведомлениях.

## Зависимости

- Python 3.8+
- aiogram - для создания Telegram бота
- Flask - для админки
- SQLAlchemy - для работы с базой данных
- schedule - для планировщика
- requests - для работы с API
- feedparser - для парсинга RSS
- beautifulsoup4 - для парсинга HTML
- lxml - парсер для BeautifulSoup
- python-dotenv - для работы с переменными окружения
- Flask-Session - для управления сессиями в админке

## Установка

1. Создайте виртуальное окружение:
   ```bash
   python -m venv
   source venv/bin/activate  # На Windows: venv\Scripts\activate
   ```

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

 4. Инициализируйте базу данных начальными данными:
    ```bash
    python initialize_database.py
    ```

 5. Запустите бота:
3. Настройте конфигурацию в `data/.env` (скопируйте из `data/.env.example`)

4. Запустите бота:
   ```bash
   python bot.py
   ```

5. Запустите админку:
   ```bash
   python admin.py
   ```

6. Запустите планировщик (в отдельном терминале):
   ```bash
   python -c "from utils.scheduler import scheduler; import asyncio; asyncio.run(scheduler.execute_task({'id': 1, 'name': 'Test Task', 'task_types': [], 'interval_type': 'hour', 'interval_value': 1}))"
   ```

## Команды бота

- `/start` - Начать работу с ботом
- `/help` - Показать помощь
- `/outages` - Показать текущие отключения
- `/stats` - Показать статистику по отключениям

## Админка

Админка доступна по адресу `http://localhost:80` по умолчанию.

### Основные разделы:

1. **Главная** - Статистика системы
2. **Группы** - Управление группами Telegram
3. **Планировщик** - Управление задачами
4. **Уведомления** - История уведомлений
5. **Отправка сообщений** - Ручная отправка сообщений

## Конфигурация

Все настройки находятся в файле `data/.env`:

- `TELEGRAM_TOKEN` - Токен Telegram бота
- `DATABASE_URL` - URL базы данных
- `OUTAGES_URL` - Адрес для парсинга отключений
- `CHECK_INTERVAL_HOURS` - Интервал проверки отключений

Для настройки Flask приложения можно использовать переменную окружения `FLASK_CONFIG` со значениями:
- `development` - для разработки
- `production` - для продакшена
- `testing` - для тестирования

## Безопасность

Приложение реализует следующие меры безопасности:

1. **Хеширование паролей** - Пароли хранятся в виде хешей с солью
2. **CSRF защита** - Все формы и API запросы защищены от CSRF атак
3. **Заголовки безопасности** - Установлены заголовки для защиты от XSS и других атак
4. **Автоматическая генерация SECRET_KEY** - Если ключ не установлен, он генерируется автоматически

Для production среды рекомендуется:
- Установить собственный SECRET_KEY в переменных окружения
- Использовать HTTPS
- Ограничить доступ к админке через firewall или reverse proxy
- Регулярно обновлять зависимости

## Логирование

Все компоненты создают лог-файлы:
- `bot.log` - Логи бота
- `scheduler.log` - Логи планировщика
- `admin.log` - Логи админки

## Тестирование

Запуск тестов:
```bash
python -m pytest tests/
```

## Разработка

### Добавление новых команд бота

1. Добавьте обработчик в `handlers/user.py`
2. Зарегистрируйте его в функции `register_handlers`

### Добавление новых задач планировщика

1. Добавьте метод в `utils/scheduler.py`
2. Зарегистрируйте задачу в `utils/scheduler.py`

### Добавление новых моделей данных

1. Добавьте модель в `databases/models.py`
2. Добавьте методы работы с моделью в `databases/manager.py`
3. Убедитесь, что добавлены необходимые индексы для улучшения производительности

### Добавление новых маршрутов в админку

1. Добавьте маршрут в `admin_routes.py`
2. Убедитесь, что маршрут зарегистрирован в Blueprint
3. Используйте декоратор `@login_required` для защиты маршрутов, требующих авторизации
4. Используйте декоратор `@csrf_protect` для защиты от CSRF атак

### Добавление новых декораторов

1. Добавьте декоратор в `decorators.py`
2. Импортируйте его в нужных файлах

### Обработка ошибок

Приложение использует централизованную обработку ошибок:
- Для Flask приложения обработчики находятся в `error_handlers.py`
- Для Telegram бота обработчик находится в `bot.py`

Все ошибки логируются в соответствующие файлы.

### Работа с базой данных

### Проверка работы планировщика

После инициализации базы данных можно проверить работу планировщика:

1. Запустите админку:
   ```bash
   python admin.py
   ```

2. Откройте браузер и перейдите по адресу `http://localhost:80`

3. Войдите в систему с учетными данными:
   - Логин: `admin`
   - Пароль: `admin`

4. Перейдите в раздел "Планировщик задач" и убедитесь, что:
   - Отображается тип задачи "Проверка отключений"
   - Существует активная задача "Проверка отключений (ежечасно)"
   - Задача правильно связана с типом задачи

Для проверки содержимого базы данных можно использовать скрипт `check_database.py`:
```bash
python check_database.py
```

### Инициализация базы данных

Для инициализации базы данных начальными данными используйте скрипт `initialize_database.py`:
```bash
python initialize_database.py
```

Этот скрипт выполняет следующие действия:
1. Создает стандартные типы задач
2. Создает начального администратора (если еще не создан)
3. Создает задачу по умолчанию для проверки отключений

Для проверки содержимого базы данных можно использовать скрипт `check_database.py`:
```bash
python check_database.py
```

Приложение использует SQLAlchemy ORM для работы с базой данных:
- Модели находятся в `databases/models.py`
- Методы работы с базой данных находятся в `databases/manager.py`
- Для управления сессиями используется `databases/database.py`

Все таблицы содержат индексы для улучшения производительности.